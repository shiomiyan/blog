---
import Search from "astro-pagefind/components/Search";
---

<div
	transition:persist
	id="backdrop"
	class="bg-[rgba(0, 0, 0, 0.5] invisible fixed top-0 left-0 z-50 flex h-screen w-full justify-center p-6 backdrop-blur-xs"
>
	<div
		id="pagefind-container"
		class="m-0 flex h-fit max-h-[80%] w-full max-w-screen-sm flex-col overflow-auto rounded-sm border border-black/15 bg-neutral-100 p-2 px-4 py-3 shadow-lg"
	>
		<Search
			id="search"
			className="pagefind-ui"
			uiOptions={{
				showImages: false,
				excerptLength: 15,
				resetStyles: false,
			}}
		/>
		<div class="mr-2 pt-4 pb-1 text-right text-xs">
			Press <span class="prose text-xs"><kbd class="">Esc</kbd></span> or click anywhere
			to close
		</div>
	</div>
</div>

<script is:inline>
	const magnifyingGlass = document.getElementById("magnifying-glass");
	const backdrop = document.getElementById("backdrop");

	function openPagefind() {
		const searchDiv = document.getElementById("search");
		const search = searchDiv.querySelector("input");
		setTimeout(() => {
			search.focus();
		}, 0);
		backdrop?.classList.remove("invisible");
		backdrop?.classList.add("visible");
	}

	function closePagefind() {
		const search = document.getElementById("search");
		search.value = "";
		backdrop?.classList.remove("visible");
		backdrop?.classList.add("invisible");
	}

	// open pagefind
	magnifyingGlass?.addEventListener("click", () => {
		openPagefind();
	});

	document.addEventListener("keydown", (e) => {
		if (e.key === "/") {
			e.preventDefault();
			openPagefind();
		} else if ((e.metaKey || e.ctrlKey) && e.key === "k") {
			e.preventDefault();
			openPagefind();
		}
	});

	// close pagefind
	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape") {
			closePagefind();
		}
	});

	backdrop?.addEventListener("click", (event) => {
		if (!event.target.closest("#pagefind-container")) {
			closePagefind();
		}
	});

	// prevent form submission
	const form = document.getElementById("form");
	form?.addEventListener("submit", (event) => {
		event.preventDefault();
	});
</script>
